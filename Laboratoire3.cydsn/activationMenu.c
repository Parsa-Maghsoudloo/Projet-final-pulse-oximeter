/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/
#include "project.h"
#include "GUI.h"
#include "pervasive_eink_hardware_driver.h"
#include "cy_eink_library.h"
#include "LCDConf.h"
#include <stdlib.h>
#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "queue.h"
#include "activationMenu.h"

uint8 imageBufferCache[CY_EINK_FRAME_SIZE] = {0};

volatile int nbSW2=0;
volatile SemaphoreHandle_t bouton_semph;
volatile bool menuActif=false;
volatile bool oldMenuActif =false;
volatile bool menuUpdate = false;
volatile bool infoActif = false;
volatile bool rcMinActif = false;
volatile bool rcMaxActif = false;
volatile bool SpO2MinActif = false;
volatile bool courbeActif = false;
volatile bool choixAlarme = false;
volatile bool DELirActif = false;
volatile bool DELrActif = false;
volatile bool entreeProgramme = true;
volatile uint8_t hauteurCercle=17;
volatile uint8_t options=0;
volatile const uint8_t NBOPTIONS =8;
volatile uint16_t rythmeCardiaque =76;
volatile uint16_t SpO2=99;

//// Variable capSense:
volatile uint16_t bouton0=0;
volatile uint16_t bouton1=0;
volatile uint8_t currentBouton0=7;
volatile uint8_t currentBouton1=7;
volatile uint8_t currentOption=0;

//// Variables options:
volatile uint8_t rcMin=76;
volatile uint8_t rcMax=120;
volatile uint8_t SPo2Min=99;
volatile uint16_t courantDELi= 30;
volatile uint16_t courantDELr = 30;
volatile bool grapheIr =true;
volatile bool alarmeActive = false;
volatile uint16_t copieBouton0;
volatile uint16_t copieBouton1;

uint32_t valeursSignalIr[]={238721,239155,238744,239946,238753,240032,239073,240717,239376,241553,239723,241443,240320,242428,240665,242439,241301,242787,241730,243056,242274,243182,242969,243474,243649,243638,244164,243931,245217,244056,245372,244485,246177,244705,246772,244982,246498,245156,247115,245122,246715,245267,246383,245141,246134,244973,245734,245155,245275,245084,244738,244906,244265,245172,243826,244723,243675,245035,243392,245140,243377,244754,243441,245404,243380,244962,243519,244950,243603,244759,243712,244600,244078,244445,244267,244188,244488,244160,245149,243993,244859,244004,245656,244027,245825,244192,245653,244424,246520,244540,246187,244915,246260,245059,246352,245219,246261,245773,246315,246047,246115,246405,246055,247026,246001,246743,245720,247153,245170,246351,244154,244895,242823,244111,241468,242277,240255,240963,238998,239779,238116,238756,237821,237988,237388,237325,237387,237060,237758,236694,237469,236831,238465,236829,238617,237274,238865,237621,239828,238000,239751,238540,240183,238852,240393,239259,240655,240086,240869,240591,240973,241303,241243,242084,241383,242293,241740,243451,241968,243705,242414,243999,242757,244910,243072,244625,243329,244890,243375,244716,243538,244517,243709,244229,243627,243768,243682,243381,243817,242899,243465,242540,243946,242165,243484,242096,243392,241963,243947,241848,243349,241932,243492,241889,243228,241975,243115,242334,242987,242368,242761,242832,242624,243298,242514,243154,242490,243953,242375,243817,242552,244008,242662,244809,242785,244365,243041,244782,243169,244625,243481,244592,243787,244622,243950,244461,244446,244415,244937,244299,244920,244332,245758,244213,245482,244289,245755,244347,246305,244113,245279,243463,244648,242226,242944,240960,241436,239884,240012,238607,238566,237895,237520,237372,236447,236692,235889,237037,235429,236523,235321,236743,235326,237459,235505,237041,235811,237733,236035,237711,236494,237861,237079,237968,237327,238119,238057,238266,238777,238426,239021,238654,240135,238754,240155,239260,240857,239593,241872,240044,241566,240462,242403,240781,242324,241029,242399,241365,242310,241491,242069,241824,241904,241955,241442,241739,241210,242225,240692,241675,240477,241930,240299,242165,240129,241411,240028,241833,239923,241379,239942,241151,239964,240892,240015,240716,240330,240529,240512,240281,240707,240223,241371,240023,241029,240138,241643,240080,242059,240278,241732,240458,242473,240628,242169,240867,242123,241086,242106,241239,241987,241741,241981,242014,241794,242246,241837,242993,241731,242744,241866,243488,241876,243738,242044,243448,242214,244235,242363,243890,242504,243815,242453,243316,241882,242161,241101,240758,239961,239115,238699,237619,237927,236164,236528,235277,236357,234335,235808,233830,235037,233616,235484,233440,234940,233627,234943,233668,234937,233943,234969,234593,235061,235020,235165,235486,235316,236361,235417,236396,235823,237502,236062,237831,236520,238089,236978,239202,237356,239102,237992,239409,238232,239617,238603,239666,239274,239788,239601,239740,239957,239689,240500,239468,240240,239493,240874,239281,240596,239067,240359,239016,240871,238786,240165,238636,239773,238260,239309,238023,239019,238246,238674,238185,238436,238514,238285,238870,237952,238638,238040,239474,237871,239335,238016,239454,238094,240164,238188,239727,238434,239941,238520,239806,238671,239748,239104,239609,239150,239472,239652,239482,240074,239304,239952,239415,240846,239252,240747,239509,241020,239672,241763,239912,241351,240119,241686,240047,241401,240156,241247,240527,241108,240554,240967,241013,240716,241201,240207,240409,239254,240099,237859,238506,236647,237323,235333,236722,234176,235062,233278,234462,232510,233567,232020,232950,231988,232584,231845,232270,232132,232168,232533,231974,232511,232147,233626,232264,233554,232623,234151,233033,235176,233389,234958,233967,235735,234249,235824,234776,236080,235345,236317,235756,236422,236490,236627,237070,236679,237317,236875,238276,236878,238125,237091,238593,237190,239229,237183,238523,237214,238887,237039,238316,236899,237986,236836,237562,236637,237156,236759,236747,236812,236344,236722,236114,237184,235768,236770,235760,237162,235662,237681,235759,237131,235894,237727,235965,237359,236111,237345,236234,237240,236357,237052,236864,237038,237150,236880,237241,236797,237952,236607,237595,236769,238330,236776,238759,236954,238354,237185,239095,237331,238771,237541,238742,237629,238672,237742,238603,238295,238509,238477,238296,238703,238308,239405,238046,239020,238117,239607,237876,239392,237328,238118,236319,237652,235076,235890,233903,234450,232591,233018,231490,231796,230902,230858,230331,229971,229976,229416,230248,228938,229689,228963,230359,228842,230499,229063,230427,229386,231419,229637,231283,230136,231525,230329,231660,230832,231833,231480,232013,231918,232097,232473,232293,233310,232373,233291,232793,234342,232936,234663,233289,234779,233594,235671,233856,235448,234197,235498,234192,235293,234219,235039,234371,234731,234286,234247,234277,233910,234504,233299,233955,233165,234519,232729,234148,232742,233928,232651,234580,232567,234022,232680,234047,232611,233876,232732,233665,233083,233559,233159,233409,233532,233357,234055,233171,233805,233260,234744,233120,234590,233316,234755,233478,235443,233514,234986,233773,235220,233807,235072,233930,235108,234426,235018,234463,234874,234931,234764,235338,234656,235241,234736,236190,234656,235957,234808,236149,234801,236893,234983,236428,235171,236655,235012,236155,234670,235313,233954,233944,232553,232292,231622,230847,230575,229256,229118,228041,228952,226957,227760,226263,227346,225799,227599,225519,226812,225550,227099,225481,226803,225639,226795,226046,226844,226206,226816,226874,226905,227384,226955,227503,227143,228613,227221,228486,227611,229057,227836,229980,228245,229692,228706,230514,229026,230510,229443,230671,229839,230730,230029,230733,230611,230656,230878,230435,230853,230283,231442,229909,230854,229812,231159,229535,231471,229349,230561,229312,230973,229073,230392,229113,230169,229049,229836,228928,229548,229271,229329,229455,229059,229421,228958,230085,228692,229796,228829,230358,228842,230764,228990,230280,229144,231015,229241,230723,229501,230759,229665,230681,229872,230569,230284,230490,230431,230258,230587,230215,231260,230071,230972,230158,231765,230192,232046,230381,231663,230608,232329,230688,232444,230930,232159,231037,232058,231125,231948,231630,231951,231762,231688,231991,231588,232607,231260,231971,230925,232046,229914,231039,228830,229394,227577,228691,226135,226963,225096,225680,223910,224524,223037,223583,222798,222804,222265,222177,222261,221808,222623,221444,222162,221548,223048,221471,223136,221741,223114,222095,224055,222327,223850,222796,224080,223024,224298,223374,224427,224031,224485,224337,224570,224861,224708,225612,224737,225506,225063,226745,225141,226694,225434,226855,225722,227716,225815,227305,225967,227289,225913,227076,225827,226735,226015,226368,225869,225982,225980,225579,226167,225227,225746,225062,226469,224744,226049,224719,226033,224713,226587,224709,226095,224878,226253,224833,226133,225001,226024,225312,225907,225423,225795,225877,225718,226317,225600,226134,225633,227146,225564,226819,225743,227075,225836,227885,225970,227352,226263,227758,226213,227572,226378,227535,226767,227451,226834,227281,227356,227249,227770,227075,227702,227195,228675,227139,228350,227193,228601,227408,229479,227525,228876,227811,229377,227798,229174,227985,229049,228199,228744,227763,227942,227303,226708,226427,225155,224923,223719,224422,222194,222694,221048,221960,220075,221718,219386,220384,218941,220428,218549,219764,218432,219479,218526,219368,218562,219189,219100,219168,219479,219095,219715,219260,220641,219263,220478,219675,221142,219879,222087,220265,221748,220695,222541,221011,222478,221406,222693,221802,222820,222104,222924,222803,223071,223190,223008,223475,223017,224287,222850,223815,222993,224381,222865,224609,222807,223952,222712,224456,222567,223893,222520,223616,222429,223335,222380,223054,222604,222775,222755,222404,222742,222340,223377,222072,222964,222197,223726,222157,223926,222379,223649,222595,224543,222629,224160,222907,224159,223135,224176,223208,224112,223792,224110,224009,223969,224289,224013,224946,223847,224658,223996,225603,223979,225685,224201,225527,224370,226265,224445,225929,224722,225993,224781,225864,224883,225826,225494,225840,225629,225658,225931,225669,226546,225460,226281,225648,227230,225672,227174,225856,227145,226031,227967,226078,227419,226090,227174,225553,226239,224533,224846,223662,223337,222315,221730,221195,220382,220476,219033,219113,218086,219314,217319,218460,216984,218123,216755,218586,216625,217999,216828,218201,216866,218143,217097,218240,217686,218234,217945,218320,218563,218498,219263,218545,219285,218829,220437,219011,220413,219432,220848,219763,221863,220167,221614,220592,222200,220848,222162,221167,222322,221639,222290,221755,222183,222314,222137,222629,221926,222340,221713,223136,221402,222425,221327,222523,221224,223114,221074,222315,221063,222604,220868,222139,220979,222017,221160,221809,221019,221571,221489,221383,221832,221221,221665,221275,222677,221108,222241,221270,222715,221362,223498,221646,222941,221865,223551,221978,223338,222253,223389,222559,223335,222676,223259,223231,223253,223521,223024,223386,222822,224101,222658,223765,222881,224321,223040,225071,223215,224567,223580,225256,223605,225043,223883,225039,224190,225052,224220,224939,224694,224819,225120,224757,225173,224745,225991,224566,225578,224729,226278,224852,226744,224964,226229,225053,226780,224738,225766,224117,224733,223015,223289,221776,221836,220942,220361,219886,219114,218947,218059,218718,217137,217694,216687,217999,216292,217991,216298,217489,216406,218298,216515,218024,216922,218212,217246,218300,217505,218435,218306,218547,218767,218779,219149,219011,220182,219089,220059,219520,221216,219847,221662,220217,221630,220671,222693,221069,222613,221480,222855,221772,222889,221901,222888,222538,222744,222659,222504,222746,222324,223056,221830,222435,221697,223099,221356,222799,221272,222449,221242,223033,221103,222522,221234,222345,221044,222096,221102,221944,221458,221773,221469,221631,221847,221586,222304,221402,222088,221576,223146,221450,222945,221648,223072,221865,223876,222045,223474,222359,223665,222413,223620,222614,223671,223141,223595,223243,223618,223796,223523,224214,223368,223949,223460,225044,223416,224827,223626,224994,223826,225795,223904,225375,224196,225663,224259,225447,224250,225162,224451,225101,224570,225055,225261,225048,225609,224980,225532,225116,226625,224989,226318,225189,226562,225272,227212,225009,225903,224319,225276,223089,223619,221836,222175,220766,220770,219548,219462,218984,218400,218359,217476,217669,216918,218159,216451,217467,216435,217766,216508,218530,216718,218070,217001,218740,217239,218743,217695,218925,218250,219054,218508,219197,219272,219399,219911,219472,220084,219770,221242,219898,221099,220306,221765,220654,222709,220963,222435,221430,223259,221776,223168,222117,223235,222420,223235,222423,223102,222913,222862,223024,222490,222841,222315,223404,221782,222730,221752,223082,221565,223492,221493,222696,221491,223248,221425,222725,221523,222557,221629,222447,221549,222292,222128,222171,222304,222007,222472,222029,223222,221893,222871,222132,223674,222249,224156,222435,223749,222729,224631,222813,224321,223186,224381,223371,224288,223472,224199,224073,224248,224164,224073,224465,224031,225151,223827,224853,224127,225709,224128,225894,224413,225614,224575,226463,224760,226205,225034,226235,225187,226219,225247,226175,225825,226125,225992,225966,226254,225932,226913,225807,226611,225955,227446,225727,227012,225140,225933,224150,225439,222912,223614,221740,222262,220482,221000,219298,219783,218923,218840,218198,217961,217967,217528,218163,217032,217680,217011,218621,216940,218468,217224,218483,217452,219637,217848,219402,218312,219618,218539,219886,218845,220031,219629,220154,219964,220346,220713,220578,221441,220674,221424,221021,222676,221206,222726,221638,223039,222005,224142,222374,223906,222818,224205,222916,224066,223018,223966,223314,223749,223176,223421,223429,223050,223571,222645,223076,222443,223808,222079,223241,221987,223300,221877,223799,221866,223271,221995,223345,221904,223133,222033,223059,222364,222955,222314,222767,222915,222706,223234,222531,223122,222651,224211,222600,223832,222837,224212,222937,224988,223146,224562,223458,225086,223524,224920,223778,224885,224087,224856,224157,224775,224786,224744,225150,224496,225079,224602,226082,224507,225630,224729,226129,224831,226900,225049,226314,225287,226942,225343,226712,225590,226708,225910,226665,225977,226541,226506,226455,226739,226259,226765,226153,227376,225570,226189,224713,225482,223385,224720,222107,222672,220935,222017,219711,220500,218867,219521,218201,218683,217546,217975,217727,217513,217578,217103,217450,216977,218289,216815,217890,217108,218618,217191,219327,217628,219078,218060,219930,218373,219927,218893,220164,219319,220375,219660,220510,220456,220706,220903,220772,221251,221039,222318,221092,222113,221488,223153,221743,223677,222071,223448,222381,224323,222496,223960,222752,223867,222689,223674,222668,223297,222913,222968,222794,222524,222720,222227,223159,221762,222570,221752,223236,221475,223203,221496,222748,221647,223512,221567,222645,221822,223037,221925,222900,222009,222842,222483,222808,222672,222644,222854,222597,223608,222504,223308,222697,224297,222729,224513,222871,224230,223159,225139,223346,224759,223609,224786,223558,224763,223771,224738,224278,224662,224390,224611,224822,224551,225492,224397,225192,224596,226263,224612,226120,224859,226223,225131,227127,225207,226729,225557,226889,225650,226795,225768,226825,226326,226714,226318,226472,226461,225818,225968,224541,224413,223132,223985,221628,222366,220501,221185,219464,220966,218613,219600,218070,219148,217509,218510,217251,218181,217480,217948,217341,217747,217911,217684,218421,217733,218415,217972,219703,218067,219529,218486,220081,218968,221076,219354,220902,219850,221557,220242,221609,220612,221873,221297,222046,221675,222215,222392,222376,222988,222405,223022,222503,224052,222455,223707,222776,224254,222878,224913,223006,224303,223079,224574,222838,223980,222815,223773,222799,223269,222489,222908,222763,222521,222742,222122,222505,221972,223484,221773,222789,221799,223141,221840,223892,221967,223247,222199,223849,222299,223616,222518,223690,222827,223646,222964,223524,223508,223571,223868,223436,223996,223532,224905,223401,224499,223631,225138,223752,225829,223951,225287,224250,225940,224300,225752,224638,225766,224852,225770,224994,225696,225635,225664,225976,225605,226103,225684,226926,225648,226657,225884,227481,225965,228033,226277,227623,226551,228359,226604,228047,226806,227857,226590,227101,225619,225767,224835,224176,223461,222598,222321,221266,221812,219894,220299,219175,220218,218428,219954,218066,219124,217882,219571,217776,219088,217969,219179,218037,219124,218163,219133,219014,219169,219255,219360,219839,219503,220682,219669,220605,220110,221751,220337,222204,220818,222156,221232,223270,221658,223201,222180,223524,222593,223795,222888,223900,223740,224069,223970,224080,224447,224105,225054,223839,224518,223926,225465,223688,225197,223567,224731,223454,225234,223275,224525,223156,224205,222891,223877,222763,223578,223080,223309,222934,223019,223176,222891,223646,222590,223268,222679,224255,222582,224060,222818,224132,222983,224960,223085,224523,223416,224508,223141,224230,223070,224018,223526,223933,223642,224004,224275,224001,224773,223954,224590,224137,225767,224135,225483,224359,225794,224636,226627,224798,226214,225136,226602,225230,226558,225523,226595,226037,226552,225989,226470,226644,226430,227075,226323,226844,226441,227978,226309,227544,226340,227511,225931,227431,224898,225512,223667,224430,222239,222833,221050,221522,220274,220351,219314,219380,219147,218614,218772,217901,218262,217663,219036,217322,218396,217441,218839,217623,219630,217784,219202,218192,219811,218418,219849,218785,220043,219372,220093,219526,220220,220357,220399,220859,220484,221124,220759,222303,220839,222074,221329,222801,221648,223723,222017,223377,222492,224136,222663,224028,222975,224032,223216,223893,223046,223697,223536,223372,223490,222896,223209,222623,223760,222139,222982,222023,223305,221807,223683,221675,222917,221743,223333,221604,222903,221772,222830,221892,222605,221721,222404,222361,222360,222587,222288,222673,222185,223468,222056,223035,222318,223878,222313,224317,222568,223770,222801,224631,222885,224298,223225,224289,223347,224237,223334,224126,224003,224129,224200,223943,224453,223952,225132,223781,224660,223970,225596,224039,225934,224249,225503,224510,226350,224600,226065,224808,226060,225001,225981,224981,225800,225366,225367,224970,224417,224151,223083,223456,221479,221517,220228,221173,218951,220055,217978,218739,217193,218749,216601,217732,216294,217283,216058,216907,215815,216699,216269,216446,216284,216390,216687,216386,217361,216339,217132,216603,218312,216700,218436,217119,218513,217478,219646,217857,219414,218384,219730,218674,219892,218889,220000,219763,220146,219959,220298,220609,220366,221309,220351,221069,220564,222123,220443,221887,220559,221745,220506,222397,220376,221684,220341,221488,220162,221121,219887,220741,220121,220399,219901,220053,220091,219741,220380,219459,219911,219400,220974,219200,220589,219322,220668,219439,221434,219453,220906,219816,221195,219840,221075,219949,221002,220395,220979,220455,220815,220989,220733,221325,220596,221140,220658,222171,220560,221839,220765,222139,220982,222990,221117,222496,221479,222876,221422,222750,221641,222711,222157,222603,222046,222551,222684,222459,223007,222320,222866,222349,223860,222205,223430,222393,223679,222401,224192,222171,223139,221649,222595,220383,221033,219218,219581,218245,218207,216906,216964,216436,215761,215726,214873,214951,214134,215303,213532,214494,213428,214672,213280,215271,213363,214665,213590,215252,213666,215111,214005,215146,214421,215256,214564,215358,215392,215429,215944,215522,216057,215701,217156,215810,216831,216233,217776,216501,218572,216854,218169,217275,219149,217531,218860,217815,218975,218149,218917,218086,218748,218577,218436,218633,218118,218430,217875,218995,217358,218168,217234,218557,217038,218821,216884,218001,216924,218560,216736,218081,216816,217990,216948,217704,216884,217595,217499,217466,217519,217297,217645,217222,218397,217043,218015,217190,218723,217321,219173,217475,218718,217671,219548,217790,219244,218064,219237,218199,219104,218196,219107,218864,219019,218999,218869,219306,218831,219921,218654,219510,218847,220451,218844,220565,219054,220346,219327,221222,219398,220865,219756,220826,219708,220805,219839,220751,220452,220642,220430,220365,220542,219935,220601,218925,219186,217927,218885,216597,217535,215457,216075,214343,215770,213361,214289,212679,213386,211905,212667,211387,212129,211584,211666,211264,211369,211516,211170,212003,210971,211689,211176,212797,211193,212845,211549,212840,211857,213875,212123,213641,212649,213960,212804,214008,213041,214179,213860,214283,214010,214379,214683,214430,215269,214476,215145,214686,216375,214729,216120,214982,216260,215039,216941,215046,216330,215058,216223,214941,215933,214785,215640,214950,215306,214758,214946,215005,214597,215161,214257,214800,214256,215673,213955,215177,214013,215392,214141,216100,214263,215643,214533,215915,214495,215777,214666,215788,215147,215682,215170,215607,215781,215511,216065,215380,216016,215476,217061,215387,216613,215679,216988,215719,217659,215885,217230,216212,217660,216229,217544,216378,217477,216760,217371,216763,217283,217385,217278,217689,217142,217637,21};
uint32_t valeursSignalr[]= {238721,239155,238744,239946,238753,240032,239073,240717,239376,241553,239723,241443,240320,242428,240665,242439,241301,242787,241730,243056,242274,243182,242969,243474,243649,243638,244164,243931,245217,244056,245372,244485,246177,244705,246772,244982,246498,245156,247115,245122,246715,245267,246383,245141,246134,244973,245734,245155,245275,245084,244738,244906,244265,245172,243826,244723,243675,245035,243392,245140,243377,244754,243441,245404,243380,244962,243519,244950,243603,244759,243712,244600,244078,244445,244267,244188,244488,244160,245149,243993,244859,244004,245656,244027,245825,244192,245653,244424,246520,244540,246187,244915,246260,245059,246352,245219,246261,245773,246315,246047,246115,246405,246055,247026,246001,246743,245720,247153,245170,246351,244154,244895,242823,244111,241468,242277,240255,240963,238998,239779,238116,238756,237821,237988,237388,237325,237387,237060,237758,236694,237469,236831,238465,236829,238617,237274,238865,237621,239828,238000,239751,238540,240183,238852,240393,239259,240655,240086,240869,240591,240973,241303,241243,242084,241383,242293,241740,243451,241968,243705,242414,243999,242757,244910,243072,244625,243329,244890,243375,244716,243538,244517,243709,244229,243627,243768,243682,243381,243817,242899,243465,242540,243946,242165,243484,242096,243392,241963,243947,241848,243349,241932,243492,241889,243228,241975,243115,242334,242987,242368,242761,242832,242624,243298,242514,243154,242490,243953,242375,243817,242552,244008,242662,244809,242785,244365,243041,244782,243169,244625,243481,244592,243787,244622,243950,244461,244446,244415,244937,244299,244920,244332,245758,244213,245482,244289,245755,244347,246305,244113,245279,243463,244648,242226,242944,240960,241436,239884,240012,238607,238566,237895,237520,237372,236447,236692,235889,237037,235429,236523,235321,236743,235326,237459,235505,237041,235811,237733,236035,237711,236494,237861,237079,237968,237327,238119,238057,238266,238777,238426,239021,238654,240135,238754,240155,239260,240857,239593,241872,240044,241566,240462,242403,240781,242324,241029,242399,241365,242310,241491,242069,241824,241904,241955,241442,241739,241210,242225,240692,241675,240477,241930,240299,242165,240129,241411,240028,241833,239923,241379,239942,241151,239964,240892,240015,240716,240330,240529,240512,240281,240707,240223,241371,240023,241029,240138,241643,240080,242059,240278,241732,240458,242473,240628,242169,240867,242123,241086,242106,241239,241987,241741,241981,242014,241794,242246,241837,242993,241731,242744,241866,243488,241876,243738,242044,243448,242214,244235,242363,243890,242504,243815,242453,243316,241882,242161,241101,240758,239961,239115,238699,237619,237927,236164,236528,235277,236357,234335,235808,233830,235037,233616,235484,233440,234940,233627,234943,233668,234937,233943,234969,234593,235061,235020,235165,235486,235316,236361,235417,236396,235823,237502,236062,237831,236520,238089,236978,239202,237356,239102,237992,239409,238232,239617,238603,239666,239274,239788,239601,239740,239957,239689,240500,239468,240240,239493,240874,239281,240596,239067,240359,239016,240871,238786,240165,238636,239773,238260,239309,238023,239019,238246,238674,238185,238436,238514,238285,238870,237952,238638,238040,239474,237871,239335,238016,239454,238094,240164,238188,239727,238434,239941,238520,239806,238671,239748,239104,239609,239150,239472,239652,239482,240074,239304,239952,239415,240846,239252,240747,239509,241020,239672,241763,239912,241351,240119,241686,240047,241401,240156,241247,240527,241108,240554,240967,241013,240716,241201,240207,240409,239254,240099,237859,238506,236647,237323,235333,236722,234176,235062,233278,234462,232510,233567,232020,232950,231988,232584,231845,232270,232132,232168,232533,231974,232511,232147,233626,232264,233554,232623,234151,233033,235176,233389,234958,233967,235735,234249,235824,234776,236080,235345,236317,235756,236422,236490,236627,237070,236679,237317,236875,238276,236878,238125,237091,238593,237190,239229,237183,238523,237214,238887,237039,238316,236899,237986,236836,237562,236637,237156,236759,236747,236812,236344,236722,236114,237184,235768,236770,235760,237162,235662,237681,235759,237131,235894,237727,235965,237359,236111,237345,236234,237240,236357,237052,236864,237038,237150,236880,237241,236797,237952,236607,237595,236769,238330,236776,238759,236954,238354,237185,239095,237331,238771,237541,238742,237629,238672,237742,238603,238295,238509,238477,238296,238703,238308,239405,238046,239020,238117,239607,237876,239392,237328,238118,236319,237652,235076,235890,233903,234450,232591,233018,231490,231796,230902,230858,230331,229971,229976,229416,230248,228938,229689,228963,230359,228842,230499,229063,230427,229386,231419,229637,231283,230136,231525,230329,231660,230832,231833,231480,232013,231918,232097,232473,232293,233310,232373,233291,232793,234342,232936,234663,233289,234779,233594,235671,233856,235448,234197,235498,234192,235293,234219,235039,234371,234731,234286,234247,234277,233910,234504,233299,233955,233165,234519,232729,234148,232742,233928,232651,234580,232567,234022,232680,234047,232611,233876,232732,233665,233083,233559,233159,233409,233532,233357,234055,233171,233805,233260,234744,233120,234590,233316,234755,233478,235443,233514,234986,233773,235220,233807,235072,233930,235108,234426,235018,234463,234874,234931,234764,235338,234656,235241,234736,236190,234656,235957,234808,236149,234801,236893,234983,236428,235171,236655,235012,236155,234670,235313,233954,233944,232553,232292,231622,230847,230575,229256,229118,228041,228952,226957,227760,226263,227346,225799,227599,225519,226812,225550,227099,225481,226803,225639,226795,226046,226844,226206,226816,226874,226905,227384,226955,227503,227143,228613,227221,228486,227611,229057,227836,229980,228245,229692,228706,230514,229026,230510,229443,230671,229839,230730,230029,230733,230611,230656,230878,230435,230853,230283,231442,229909,230854,229812,231159,229535,231471,229349,230561,229312,230973,229073,230392,229113,230169,229049,229836,228928,229548,229271,229329,229455,229059,229421,228958,230085,228692,229796,228829,230358,228842,230764,228990,230280,229144,231015,229241,230723,229501,230759,229665,230681,229872,230569,230284,230490,230431,230258,230587,230215,231260,230071,230972,230158,231765,230192,232046,230381,231663,230608,232329,230688,232444,230930,232159,231037,232058,231125,231948,231630,231951,231762,231688,231991,231588,232607,231260,231971,230925,232046,229914,231039,228830,229394,227577,228691,226135,226963,225096,225680,223910,224524,223037,223583,222798,222804,222265,222177,222261,221808,222623,221444,222162,221548,223048,221471,223136,221741,223114,222095,224055,222327,223850,222796,224080,223024,224298,223374,224427,224031,224485,224337,224570,224861,224708,225612,224737,225506,225063,226745,225141,226694,225434,226855,225722,227716,225815,227305,225967,227289,225913,227076,225827,226735,226015,226368,225869,225982,225980,225579,226167,225227,225746,225062,226469,224744,226049,224719,226033,224713,226587,224709,226095,224878,226253,224833,226133,225001,226024,225312,225907,225423,225795,225877,225718,226317,225600,226134,225633,227146,225564,226819,225743,227075,225836,227885,225970,227352,226263,227758,226213,227572,226378,227535,226767,227451,226834,227281,227356,227249,227770,227075,227702,227195,228675,227139,228350,227193,228601,227408,229479,227525,228876,227811,229377,227798,229174,227985,229049,228199,228744,227763,227942,227303,226708,226427,225155,224923,223719,224422,222194,222694,221048,221960,220075,221718,219386,220384,218941,220428,218549,219764,218432,219479,218526,219368,218562,219189,219100,219168,219479,219095,219715,219260,220641,219263,220478,219675,221142,219879,222087,220265,221748,220695,222541,221011,222478,221406,222693,221802,222820,222104,222924,222803,223071,223190,223008,223475,223017,224287,222850,223815,222993,224381,222865,224609,222807,223952,222712,224456,222567,223893,222520,223616,222429,223335,222380,223054,222604,222775,222755,222404,222742,222340,223377,222072,222964,222197,223726,222157,223926,222379,223649,222595,224543,222629,224160,222907,224159,223135,224176,223208,224112,223792,224110,224009,223969,224289,224013,224946,223847,224658,223996,225603,223979,225685,224201,225527,224370,226265,224445,225929,224722,225993,224781,225864,224883,225826,225494,225840,225629,225658,225931,225669,226546,225460,226281,225648,227230,225672,227174,225856,227145,226031,227967,226078,227419,226090,227174,225553,226239,224533,224846,223662,223337,222315,221730,221195,220382,220476,219033,219113,218086,219314,217319,218460,216984,218123,216755,218586,216625,217999,216828,218201,216866,218143,217097,218240,217686,218234,217945,218320,218563,218498,219263,218545,219285,218829,220437,219011,220413,219432,220848,219763,221863,220167,221614,220592,222200,220848,222162,221167,222322,221639,222290,221755,222183,222314,222137,222629,221926,222340,221713,223136,221402,222425,221327,222523,221224,223114,221074,222315,221063,222604,220868,222139,220979,222017,221160,221809,221019,221571,221489,221383,221832,221221,221665,221275,222677,221108,222241,221270,222715,221362,223498,221646,222941,221865,223551,221978,223338,222253,223389,222559,223335,222676,223259,223231,223253,223521,223024,223386,222822,224101,222658,223765,222881,224321,223040,225071,223215,224567,223580,225256,223605,225043,223883,225039,224190,225052,224220,224939,224694,224819,225120,224757,225173,224745,225991,224566,225578,224729,226278,224852,226744,224964,226229,225053,226780,224738,225766,224117,224733,223015,223289,221776,221836,220942,220361,219886,219114,218947,218059,218718,217137,217694,216687,217999,216292,217991,216298,217489,216406,218298,216515,218024,216922,218212,217246,218300,217505,218435,218306,218547,218767,218779,219149,219011,220182,219089,220059,219520,221216,219847,221662,220217,221630,220671,222693,221069,222613,221480,222855,221772,222889,221901,222888,222538,222744,222659,222504,222746,222324,223056,221830,222435,221697,223099,221356,222799,221272,222449,221242,223033,221103,222522,221234,222345,221044,222096,221102,221944,221458,221773,221469,221631,221847,221586,222304,221402,222088,221576,223146,221450,222945,221648,223072,221865,223876,222045,223474,222359,223665,222413,223620,222614,223671,223141,223595,223243,223618,223796,223523,224214,223368,223949,223460,225044,223416,224827,223626,224994,223826,225795,223904,225375,224196,225663,224259,225447,224250,225162,224451,225101,224570,225055,225261,225048,225609,224980,225532,225116,226625,224989,226318,225189,226562,225272,227212,225009,225903,224319,225276,223089,223619,221836,222175,220766,220770,219548,219462,218984,218400,218359,217476,217669,216918,218159,216451,217467,216435,217766,216508,218530,216718,218070,217001,218740,217239,218743,217695,218925,218250,219054,218508,219197,219272,219399,219911,219472,220084,219770,221242,219898,221099,220306,221765,220654,222709,220963,222435,221430,223259,221776,223168,222117,223235,222420,223235,222423,223102,222913,222862,223024,222490,222841,222315,223404,221782,222730,221752,223082,221565,223492,221493,222696,221491,223248,221425,222725,221523,222557,221629,222447,221549,222292,222128,222171,222304,222007,222472,222029,223222,221893,222871,222132,223674,222249,224156,222435,223749,222729,224631,222813,224321,223186,224381,223371,224288,223472,224199,224073,224248,224164,224073,224465,224031,225151,223827,224853,224127,225709,224128,225894,224413,225614,224575,226463,224760,226205,225034,226235,225187,226219,225247,226175,225825,226125,225992,225966,226254,225932,226913,225807,226611,225955,227446,225727,227012,225140,225933,224150,225439,222912,223614,221740,222262,220482,221000,219298,219783,218923,218840,218198,217961,217967,217528,218163,217032,217680,217011,218621,216940,218468,217224,218483,217452,219637,217848,219402,218312,219618,218539,219886,218845,220031,219629,220154,219964,220346,220713,220578,221441,220674,221424,221021,222676,221206,222726,221638,223039,222005,224142,222374,223906,222818,224205,222916,224066,223018,223966,223314,223749,223176,223421,223429,223050,223571,222645,223076,222443,223808,222079,223241,221987,223300,221877,223799,221866,223271,221995,223345,221904,223133,222033,223059,222364,222955,222314,222767,222915,222706,223234,222531,223122,222651,224211,222600,223832,222837,224212,222937,224988,223146,224562,223458,225086,223524,224920,223778,224885,224087,224856,224157,224775,224786,224744,225150,224496,225079,224602,226082,224507,225630,224729,226129,224831,226900,225049,226314,225287,226942,225343,226712,225590,226708,225910,226665,225977,226541,226506,226455,226739,226259,226765,226153,227376,225570,226189,224713,225482,223385,224720,222107,222672,220935,222017,219711,220500,218867,219521,218201,218683,217546,217975,217727,217513,217578,217103,217450,216977,218289,216815,217890,217108,218618,217191,219327,217628,219078,218060,219930,218373,219927,218893,220164,219319,220375,219660,220510,220456,220706,220903,220772,221251,221039,222318,221092,222113,221488,223153,221743,223677,222071,223448,222381,224323,222496,223960,222752,223867,222689,223674,222668,223297,222913,222968,222794,222524,222720,222227,223159,221762,222570,221752,223236,221475,223203,221496,222748,221647,223512,221567,222645,221822,223037,221925,222900,222009,222842,222483,222808,222672,222644,222854,222597,223608,222504,223308,222697,224297,222729,224513,222871,224230,223159,225139,223346,224759,223609,224786,223558,224763,223771,224738,224278,224662,224390,224611,224822,224551,225492,224397,225192,224596,226263,224612,226120,224859,226223,225131,227127,225207,226729,225557,226889,225650,226795,225768,226825,226326,226714,226318,226472,226461,225818,225968,224541,224413,223132,223985,221628,222366,220501,221185,219464,220966,218613,219600,218070,219148,217509,218510,217251,218181,217480,217948,217341,217747,217911,217684,218421,217733,218415,217972,219703,218067,219529,218486,220081,218968,221076,219354,220902,219850,221557,220242,221609,220612,221873,221297,222046,221675,222215,222392,222376,222988,222405,223022,222503,224052,222455,223707,222776,224254,222878,224913,223006,224303,223079,224574,222838,223980,222815,223773,222799,223269,222489,222908,222763,222521,222742,222122,222505,221972,223484,221773,222789,221799,223141,221840,223892,221967,223247,222199,223849,222299,223616,222518,223690,222827,223646,222964,223524,223508,223571,223868,223436,223996,223532,224905,223401,224499,223631,225138,223752,225829,223951,225287,224250,225940,224300,225752,224638,225766,224852,225770,224994,225696,225635,225664,225976,225605,226103,225684,226926,225648,226657,225884,227481,225965,228033,226277,227623,226551,228359,226604,228047,226806,227857,226590,227101,225619,225767,224835,224176,223461,222598,222321,221266,221812,219894,220299,219175,220218,218428,219954,218066,219124,217882,219571,217776,219088,217969,219179,218037,219124,218163,219133,219014,219169,219255,219360,219839,219503,220682,219669,220605,220110,221751,220337,222204,220818,222156,221232,223270,221658,223201,222180,223524,222593,223795,222888,223900,223740,224069,223970,224080,224447,224105,225054,223839,224518,223926,225465,223688,225197,223567,224731,223454,225234,223275,224525,223156,224205,222891,223877,222763,223578,223080,223309,222934,223019,223176,222891,223646,222590,223268,222679,224255,222582,224060,222818,224132,222983,224960,223085,224523,223416,224508,223141,224230,223070,224018,223526,223933,223642,224004,224275,224001,224773,223954,224590,224137,225767,224135,225483,224359,225794,224636,226627,224798,226214,225136,226602,225230,226558,225523,226595,226037,226552,225989,226470,226644,226430,227075,226323,226844,226441,227978,226309,227544,226340,227511,225931,227431,224898,225512,223667,224430,222239,222833,221050,221522,220274,220351,219314,219380,219147,218614,218772,217901,218262,217663,219036,217322,218396,217441,218839,217623,219630,217784,219202,218192,219811,218418,219849,218785,220043,219372,220093,219526,220220,220357,220399,220859,220484,221124,220759,222303,220839,222074,221329,222801,221648,223723,222017,223377,222492,224136,222663,224028,222975,224032,223216,223893,223046,223697,223536,223372,223490,222896,223209,222623,223760,222139,222982,222023,223305,221807,223683,221675,222917,221743,223333,221604,222903,221772,222830,221892,222605,221721,222404,222361,222360,222587,222288,222673,222185,223468,222056,223035,222318,223878,222313,224317,222568,223770,222801,224631,222885,224298,223225,224289,223347,224237,223334,224126,224003,224129,224200,223943,224453,223952,225132,223781,224660,223970,225596,224039,225934,224249,225503,224510,226350,224600,226065,224808,226060,225001,225981,224981,225800,225366,225367,224970,224417,224151,223083,223456,221479,221517,220228,221173,218951,220055,217978,218739,217193,218749,216601,217732,216294,217283,216058,216907,215815,216699,216269,216446,216284,216390,216687,216386,217361,216339,217132,216603,218312,216700,218436,217119,218513,217478,219646,217857,219414,218384,219730,218674,219892,218889,220000,219763,220146,219959,220298,220609,220366,221309,220351,221069,220564,222123,220443,221887,220559,221745,220506,222397,220376,221684,220341,221488,220162,221121,219887,220741,220121,220399,219901,220053,220091,219741,220380,219459,219911,219400,220974,219200,220589,219322,220668,219439,221434,219453,220906,219816,221195,219840,221075,219949,221002,220395,220979,220455,220815,220989,220733,221325,220596,221140,220658,222171,220560,221839,220765,222139,220982,222990,221117,222496,221479,222876,221422,222750,221641,222711,222157,222603,222046,222551,222684,222459,223007,222320,222866,222349,223860,222205,223430,222393,223679,222401,224192,222171,223139,221649,222595,220383,221033,219218,219581,218245,218207,216906,216964,216436,215761,215726,214873,214951,214134,215303,213532,214494,213428,214672,213280,215271,213363,214665,213590,215252,213666,215111,214005,215146,214421,215256,214564,215358,215392,215429,215944,215522,216057,215701,217156,215810,216831,216233,217776,216501,218572,216854,218169,217275,219149,217531,218860,217815,218975,218149,218917,218086,218748,218577,218436,218633,218118,218430,217875,218995,217358,218168,217234,218557,217038,218821,216884,218001,216924,218560,216736,218081,216816,217990,216948,217704,216884,217595,217499,217466,217519,217297,217645,217222,218397,217043,218015,217190,218723,217321,219173,217475,218718,217671,219548,217790,219244,218064,219237,218199,219104,218196,219107,218864,219019,218999,218869,219306,218831,219921,218654,219510,218847,220451,218844,220565,219054,220346,219327,221222,219398,220865,219756,220826,219708,220805,219839,220751,220452,220642,220430,220365,220542,219935,220601,218925,219186,217927,218885,216597,217535,215457,216075,214343,215770,213361,214289,212679,213386,211905,212667,211387,212129,211584,211666,211264,211369,211516,211170,212003,210971,211689,211176,212797,211193,212845,211549,212840,211857,213875,212123,213641,212649,213960,212804,214008,213041,214179,213860,214283,214010,214379,214683,214430,215269,214476,215145,214686,216375,214729,216120,214982,216260,215039,216941,215046,216330,215058,216223,214941,215933,214785,215640,214950,215306,214758,214946,215005,214597,215161,214257,214800,214256,215673,213955,215177,214013,215392,214141,216100,214263,215643,214533,215915,214495,215777,214666,215788,215147,215682,215170,215607,215781,215511,216065,215380,216016,215476,217061,215387,216613,215679,216988,215719,217659,215885,217230,216212,217660,216229,217544,216378,217477,216760,217371,216763,217283,217385,217278,217689,217142,217637,21};

void initialisation (void) {
     bouton_semph = xSemaphoreCreateBinary();
    
    __enable_irq();
    
    /* Initialize emWin Graphics */
    GUI_Init();

    /* Start the eInk display interface and turn on the display power */
    Cy_EINK_Start(20);
    Cy_EINK_Power(1);
  
    
    GUI_SetPenSize(1);
    GUI_SetColor(GUI_BLACK);
    GUI_SetBkColor(GUI_WHITE);
    GUI_Clear();
   
    Cy_SysInt_Init(&SW2_isr_cfg, isr_bouton);
    NVIC_ClearPendingIRQ(SW2_isr_cfg.intrSrc);
    NVIC_EnableIRQ(SW2_isr_cfg.intrSrc);
}

void DesactiverPage(void) {
   
        infoActif = false;
        rcMinActif = false;
        courbeActif =false;
        choixAlarme =false;
        rcMaxActif =false;
        SpO2MinActif =false;
        DELirActif =false;
        DELrActif =false;
    
}
void isr_bouton(void){
    
    nbSW2++;
    DesactiverPage();
    xSemaphoreGiveFromISR(bouton_semph,NULL);
    Cy_GPIO_ClearInterrupt(SW2_PORT, SW2_NUM );
    NVIC_ClearPendingIRQ(SW2_isr_cfg.intrSrc);
}


void activerMenu() {   
    for (;;) {
    vTaskDelay(pdMS_TO_TICKS(50));
    if (xSemaphoreTake(bouton_semph, 0)==true) {
        if (nbSW2 % 2 !=0) {
            
            menuActif = true;
        }
        else {
            menuActif=false;
            
        }     
    }
    }
}
void UpdateDisplay(cy_eink_update_t updateMethod, bool powerCycle)
{
    cy_eink_frame_t* pEmwinBuffer;

    /* Get the pointer to Emwin's display buffer */
    pEmwinBuffer = (cy_eink_frame_t*)LCD_GetDisplayBuffer();

    /* Update the EInk display */
    Cy_EINK_ShowFrame(imageBufferCache, pEmwinBuffer, updateMethod, powerCycle);

    /* Copy the EmWin display buffer to the imageBuffer cache*/
    memcpy(imageBufferCache, pEmwinBuffer, CY_EINK_FRAME_SIZE);
}

void ClearScreen(void)
{
    GUI_SetColor(GUI_BLACK);
    GUI_SetBkColor(GUI_WHITE);
    GUI_Clear();
    UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}

void DessinerGraphique(uint32_t* signal){
    
  
    int16_t signalAffiche[100]={};
    uint32_t max=0;
    uint32_t min = 1000000;
    for (int i=0; i <201; i++) {
        if(signal[i] < min) {
            min=signal[i];
        }
        if(signal[i] > max) {
            max=signal[i];
        }
    }
    int32_t facteurEchelle = (max-min)/116;
   
    for (int i=0; i<201 ; i=i+2) {
        signalAffiche[i/2] = ((signal[i]-min)/facteurEchelle);
       
    }
    GUI_DrawGraph(&signalAffiche[0], 100, 8, 20);
    
}
void afficherMenu()
{
    
   for(;;) {
    
    if (menuActif == true && infoActif == false && rcMinActif == false && courbeActif == false && choixAlarme == false && rcMaxActif == false && SpO2MinActif == false && DELrActif == false && DELirActif == false) {
        if (oldMenuActif != menuActif) {
        menuUpdate = true;
        oldMenuActif = menuActif;
        }
        GUI_Clear();
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Desactiver alarme", 40, 15);
        GUI_DispStringAt("Obtenir les informations", 40, 35);
        GUI_DispStringAt("Definir les bornes : ", 40, 55);
        GUI_DispStringAt("Rythme cardiaque minimal", 130, 55);
        GUI_DispStringAt("Rythme cardiaque maximal", 130, 75);
        GUI_DispStringAt("SpO2 minimal", 130, 95);
        GUI_DispStringAt("Changer courbe saturation", 40, 115);
        GUI_DispStringAt("Modifier courant : ", 40, 135);
        GUI_DispStringAt("DELir", 125, 135);
        GUI_DispStringAt("DELr", 125, 155);
        GUI_DrawCircle(25, hauteurCercle, 3);
        if (menuUpdate == true) {
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
        vTaskDelay(pdMS_TO_TICKS(50));
        menuUpdate = false;
            }
    }
        vTaskDelay(pdMS_TO_TICKS(500));
    }

}
void afficherEcranPrincipal()
{
   for (;;) {
   if (menuActif == false) {
    if (oldMenuActif != menuActif) {
        menuUpdate = true;
        GUI_Clear();
        oldMenuActif = menuActif;
    } 
    activerAlarme();
     if (alarmeActive == true) {
        GUI_SetFont(GUI_FONT_32_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("L'alarme est active", 15, 60);
        GUI_SetFont(GUI_FONT_16_1);
        GUI_DispStringAt("Veuillez la desactiver pour poursuivre", 15, 90);
    }
    else {
    char rc[3];
    char spo2[3];
    
    sprintf(rc, "%d", rythmeCardiaque);
    sprintf(spo2, "%d", SpO2);
    
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Rythme cardiaque (batt/min) : ", 10, 150);
        GUI_DispStringAt(rc, 150, 150);
        GUI_DispStringAt("SpO2 (%):", 170, 150);
        GUI_DispStringAt(spo2, 220, 150);
        
        if (grapheIr ==true) {
            GUI_DispStringAt("Courbe infrarouge", 100, 8);
            DessinerGraphique(&valeursSignalIr[0]);
        }
        else {
            GUI_DispStringAt("Courbe rouge", 100, 8);
            DessinerGraphique(&valeursSignalr[0]);
        }
            
        
       }
        if (menuUpdate == true || entreeProgramme==true) {
           UpdateDisplay(CY_EINK_FULL_4STAGE, true);
           vTaskDelay(pdMS_TO_TICKS(50));
           menuUpdate = false;
           entreeProgramme = false;
        }

    }
    vTaskDelay(pdMS_TO_TICKS(500));
    }  
}

void afficherInfo()
{
    char bufferRcMin[3];
    char bufferRcMax[3];
    char bufferSpO2[3];
    char bufferDELi[5];
    char bufferDELr[5];
    
    sprintf(bufferRcMin, "%d", rcMin);
    sprintf(bufferRcMax, "%d", rcMax);
    sprintf(bufferSpO2, "%d", SPo2Min);
    sprintf(bufferDELi, "%d", courantDELi);
    sprintf(bufferDELr, "%d", courantDELr);
    
   GUI_Clear();
   GUI_SetFont(GUI_FONT_8_1);
   GUI_SetTextAlign(GUI_TA_LEFT);

   GUI_DispStringAt("Informations", 100,15);
   GUI_DispStringAt("Rythme cardiaque : ", 20, 55);
   GUI_DispStringAt(bufferRcMin, 115, 55);
   GUI_DispStringAt(" a ", 135, 55);
   GUI_DispStringAt(bufferRcMax, 150, 55);
   GUI_DispStringAt(" batt/sec ", 170, 55);

   GUI_DispStringAt("SpO2 minimal : ", 20, 80); 
   GUI_DispStringAt(bufferSpO2, 100, 80);
   GUI_DispStringAt(" % ", 120, 80);

   GUI_DispStringAt("Courant DELi : ", 20, 105);
   GUI_DispStringAt(bufferDELi, 100, 105);
   GUI_DispStringAt(" mV ", 120, 105);

   GUI_DispStringAt("Courant DELr : ", 20, 130);
   GUI_DispStringAt(bufferDELr, 100, 130);
   GUI_DispStringAt(" mV ", 120, 130);

   if (alarmeActive == false) {
    GUI_DispStringAt("Aucune alarme n'est activee ", 20, 155);
    }
   else {
    GUI_DispStringAt("L'alarme est activee ", 20, 150);
}
   UpdateDisplay(CY_EINK_FULL_4STAGE, true);

}
void afficherRCMin()
{
    
        GUI_Clear();
        char bufferRcMin[3];
        sprintf(bufferRcMin, "%d", rcMin);
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Definir rythme cardiaque minimal", 60, 60);
        GUI_SetFont(GUI_FONT_32_1);
        GUI_DispStringAt(bufferRcMin, 110, 75);
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);

        
}
void afficherRCMax()
{
        GUI_Clear();
        char bufferRcMax[3];
        sprintf(bufferRcMax, "%d", rcMax);
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Definir rythme cardiaque maximal", 60, 60);
        GUI_SetFont(GUI_FONT_32_1);
        GUI_DispStringAt(bufferRcMax, 110, 75);
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}
void afficherSpO2Min()
{
        GUI_Clear();
        char bufferSpO2[3];
        sprintf(bufferSpO2, "%d", SPo2Min);
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Definir SpO2 minimal", 70, 60);
        GUI_SetFont(GUI_FONT_32_1);
        GUI_DispStringAt(bufferSpO2, 110, 75);
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}

void afficherChoixCourbe()
{
        GUI_Clear();
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("Votre choix a bien ete enregistre.", 50, 55);
        if (grapheIr == true) {
            GUI_DispStringAt("La courbe rouge sera affichee.", 55, 80);
            grapheIr =false;
        }
        else {
            GUI_DispStringAt("La courbe infrarouge sera affichee.", 45, 80);
            grapheIr = true;
        }
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}
void afficherChoixAlarme()
{
        GUI_Clear();
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        if (alarmeActive == true) {
            GUI_DispStringAt("L'alarme a ete desactivee", 55, 80);
            alarmeActive =false;
        }
        else {
            GUI_DispStringAt("L'alarme n'est pas active", 55, 80);
        }
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}
void afficherDELir()
{
        GUI_Clear();
        char bufferDELir[3];
        sprintf(bufferDELir, "%d", courantDELi);
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("DELir", 110, 60);
        GUI_SetFont(GUI_FONT_32_1);
        GUI_DispStringAt(bufferDELir, 110, 75);
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}

void afficherDELr()
{
        GUI_Clear();
        char bufferDELr[3];
        sprintf(bufferDELr, "%d", courantDELr);
        GUI_SetFont(GUI_FONT_8_1);
        GUI_SetTextAlign(GUI_TA_LEFT);
        GUI_DispStringAt("DELr", 110, 60);
        GUI_SetFont(GUI_FONT_32_1);
        GUI_DispStringAt(bufferDELr, 110, 75);
        UpdateDisplay(CY_EINK_FULL_4STAGE, true);
}
void copierValeurBouton (void) {
    
    copieBouton0 = bouton0;
    copieBouton1 = bouton1;
}

void actionSensor4 (void) {
    switch (options) {
        case 0 : choixAlarme =true; afficherChoixAlarme();
            break;
        case 1 : infoActif = true; afficherInfo();
            break;
        case 2 : rcMinActif = true; copierValeurBouton(); afficherRCMin();
            break;
        case 3 : rcMaxActif =true; copierValeurBouton(); afficherRCMax();
            break ;
        case 4 : SpO2MinActif =true; copierValeurBouton(); afficherSpO2Min();
            break ;
        case 5: courbeActif= true; afficherChoixCourbe();
            break;
        case 6: DELirActif=true; copierValeurBouton(); afficherDELir();
            break;
        case 7: DELrActif = true; copierValeurBouton(); afficherDELr();
            break;
    }
}
void actionSensor0 (void) {
    DesactiverPage();
    menuUpdate= true;
}
void deplacerCurseur(void) {
  
    if (currentBouton0 != bouton0) {
        currentBouton0 = bouton0;
        currentOption ++;
        menuUpdate =true;
    }
    if (currentBouton1 != bouton1) {
        currentBouton1 = bouton1;
        currentOption--;
        menuUpdate =true;   
    }
    
    options = currentOption % NBOPTIONS  ;
    hauteurCercle = (16 + options*20) ;
    
 }

void changerValeur (void) {
    
    if (copieBouton0 != bouton0 && currentBouton0 !=bouton0) {
        currentBouton0 = bouton0;
        if (rcMinActif == true){
            rcMin--;
            afficherRCMin();
        }
         if (rcMaxActif == true){
            rcMax--;
            afficherRCMax();
        }
        if (SpO2MinActif ==true) {
            SPo2Min --;
            afficherSpO2Min();
        }
        if (DELirActif ==true) {
            if (courantDELi <= 4){
                courantDELi =0;
                afficherDELir();
            }
            else {
            courantDELi = courantDELi-5;
            afficherDELir();
            }
        }
        if (DELrActif ==true) {
            if (courantDELr <= 4){
                courantDELr =0;
                afficherDELr();
            }
            else {
            courantDELr = courantDELr-5;
            afficherDELr();
            }
        }
    
    }
     if (copieBouton1 != bouton1 && currentBouton1 != bouton1) {
        currentBouton1 = bouton1;
        if (rcMinActif == true){
            rcMin++;
            afficherRCMin();
        }
        if (rcMaxActif == true){
            rcMax++;
            afficherRCMax();
        }
        if (SpO2MinActif ==true) {
            SPo2Min ++;
            afficherSpO2Min();
        }
        if (DELirActif ==true) {
            if (courantDELi >= 46){
                courantDELi =50;
                afficherDELir();
            }
            else {
            courantDELi = courantDELi+5;
            afficherDELir();
            }
        }
         if (DELrActif ==true) {
            if (courantDELr >= 46){
                courantDELr =50;
                afficherDELr();
            }
            else {
            courantDELr = courantDELr+5;
            afficherDELr();
            }
        }
    }
    
}

void choixCurseur(void) {
    if (rcMinActif == false && rcMaxActif == false && SpO2MinActif == false && DELirActif ==false && DELrActif==false) {
        deplacerCurseur();
    }
    else {
        changerValeur();
    }
    
}

void capSense_task(void)
{
    for(;;)
    {
        if (nbSW2 ==0) {
            CapSense_Start();
            CapSense_ScanAllWidgets();
        }
        if (menuActif == true && !CapSense_IsBusy()) {
        CapSense_ProcessAllWidgets();
           
            if(CapSense_IsWidgetActive(CapSense_BUTTON0_WDGT_ID)){
             bouton0++;
            }
        
            if(CapSense_IsWidgetActive(CapSense_BUTTON1_WDGT_ID)){
               bouton1++;
            }
            if (CapSense_IsWidgetActive(CapSense_SNS0_WDGT_ID)) {
                actionSensor0();
            }
            if (CapSense_IsWidgetActive(CapSense_SNS4_WDGT_ID)) {
                actionSensor4();
            }
            
        
        CapSense_UpdateAllBaselines();
        CapSense_ScanAllWidgets();
        choixCurseur();
        
        }
        vTaskDelay(pdMS_TO_TICKS(100));
    }
        
    }
void activerAlarme(void) {
    if ( SpO2 < SPo2Min || rythmeCardiaque< rcMin || rythmeCardiaque > rcMax) {
        alarmeActive = true;
    }
}
    


/* [] END OF FILE */
